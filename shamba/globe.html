<!DOCTYPE html>
<html>
  <head>
    <title>Map Dashboard</title>
    <style>
      body,
      html {
        margin: 0;
        padding: 0;
        height: 100%;
        font-family: Arial, sans-serif;
      }

      .container {
        display: flex;
        height: 100vh;
        width: 100%;
      }
      #countyDropdown {
        width: 100%;
        padding: 10px;
        margin-top: 10px;
        border-radius: 5px;
        border: 1px solid #ccc;
      }

      .sidebar {
        width: 300px;
        background-color: #1e1e2f;
        color: white;
        padding: 20px;
        box-sizing: border-box;
      }

      .sidebar h2 {
        margin-top: 0;
        font-size: 24px;
        border-bottom: 1px solid #444;
        padding-bottom: 10px;
      }
      .sidebar-row {
        display: flex;
        justify-content: space-between;
        gap: 10px;
        margin-top: 10px;
      }

      .sidebar-row input,
      .sidebar-row button {
        flex: 1;
      }

      .half-button {
        padding: 10px;
        background-color: rgb(7, 79, 17);
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }

      .half-button:hover {
        background-color: #4e4d4f;
      }

      #map {
        flex: 1;
        height: 100%;
      }
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        padding-top: 100px;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.4);
      }

      .modal-content {
        background-color: #fff;
        margin: auto;
        padding: 20px;
        border-radius: 8px;
        width: 90%;
        max-width: 400px;
      }

      .close {
        float: right;
        font-size: 24px;
        cursor: pointer;
        color: #aaa;
      }
      #loader {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgb(8, 8, 8);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        transition: opacity 0.6s ease;
      }

      .loader-logo {
        width: 1000px;
        animation: pulse 1.3s infinite ease-in-out;
      }

      #loader p {
        font-size: 16px;
        color: #333;
        margin-top: 15px;
      }

      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
          opacity: 0.9;
        }
        50% {
          transform: scale(1.1);
          opacity: 1;
        }
      }

      .hidden {
        display: none !important;
      }
      /* Common modal overlay */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        backdrop-filter: blur(8px);
        background-color: rgba(0, 0, 0, 0.4);
      }

      /* Centered modal content with glass effect */
      .modal-content {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        padding: 30px;
        border-radius: 15px;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(15px);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.25);
        color: #fff;
        width: 350px;
        font-family: "Segoe UI", sans-serif;
        text-align: left;
      }

      /* Input styles */
      .modal-content input {
        width: 100%;
        padding: 10px;
        margin: 10px 0 20px;
        border: none;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.2);
        color: #fff;
      }

      /* Button group */
      .modal-buttons {
        display: flex;
        justify-content: space-between;
      }

      /* Button styles */
      .modal-content button {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        background: #043e13;
        color: white;
        cursor: pointer;
        font-weight: bold;
        transition: background 0.3s;
      }

      .modal-content button:hover {
        background: #007a52;
      }
    </style>
  </head>
  <body>
    <div id="loader">
      <img
        src="Screenshot 2025-07-27 210037.png"
        alt="Loading Logo"
        class="loader-logo"
      />
      <br />
      <br />
      <br />
      <br />
      <br />
      <br />
      <p>...................loading.....................</p>
    </div>

    <div class="container">
      <div class="sidebar">
        <h3>Welcome To:</h3>
        <img
          src="Screenshot 2025-07-27 210037.png"
          alt="Track Lands Logo"
          style="width: 250px; margin-bottom: 10px"
        />

        <h3>Go To:</h3>
        <select id="countyDropdown" onchange="goToCounty()">
          <option value="">-- Search by County --</option>
          <option value="baringo">Baringo</option>
          <option value="bomet">Bomet</option>
          <option value="bungoma">Bungoma</option>
          <option value="busia">Busia</option>
          <option value="elgeyo marakwet">Elgeyo Marakwet</option>
          <option value="embu">Embu</option>
          <option value="garissa">Garissa</option>
          <option value="homa bay">Homa Bay</option>
          <option value="isiolo">Isiolo</option>
          <option value="kajiado">Kajiado</option>
          <option value="kakamega">Kakamega</option>
          <option value="kericho">Kericho</option>
          <option value="kiambu">Kiambu</option>
          <option value="kilifi">Kilifi</option>
          <option value="kirinyaga">Kirinyaga</option>
          <option value="kisii">Kisii</option>
          <option value="kisumu">Kisumu</option>
          <option value="kitui">Kitui</option>
          <option value="kwale">Kwale</option>
          <option value="laikipia">Laikipia</option>
          <option value="lamu">Lamu</option>
          <option value="machakos">Machakos</option>
          <option value="makueni">Makueni</option>
          <option value="mandera">Mandera</option>
          <option value="marsabit">Marsabit</option>
          <option value="meru">Meru</option>
          <option value="migori">Migori</option>
          <option value="mombasa">Mombasa</option>
          <option value="muranga">Murang'a</option>
          <option value="nairobi">Nairobi</option>
          <option value="nakuru">Nakuru</option>
          <option value="nandi">Nandi</option>
          <option value="narok">Narok</option>
          <option value="nyamira">Nyamira</option>
          <option value="nyandarua">Nyandarua</option>
          <option value="nyeri">Nyeri</option>
          <option value="samburu">Samburu</option>
          <option value="siaya">Siaya</option>
          <option value="taita taveta">Taita Taveta</option>
          <option value="tana river">Tana River</option>
          <option value="tharaka nithi">Tharaka Nithi</option>
          <option value="trans nzoia">Trans Nzoia</option>
          <option value="turkana">Turkana</option>
          <option value="uasin gishu">Uasin Gishu</option>
          <option value="vihiga">Vihiga</option>
          <option value="wajir">Wajir</option>
          <option value="west pokot">West Pokot</option>
        </select>
        <input
          type="text"
          id="parcelInput"
          placeholder="Enter Parcel ID"
          style="width: 100%; padding: 8px; margin-top: 10px"
        />

        <button onclick="searchParcel()" style="width: 100%; margin-top: 5px">
          Search Parcel
        </button>
        <div class="sidebar-row">
          <button onclick="openBuyModal()" class="half-button">Buy Land</button>
          <button onclick="openSellModal()" class="half-button">
            Sell Land
          </button>
        </div>
        <div id="sellModal" class="modal">
          <div class="modal-content">
            <span class="close" onclick="closeSellModal()">×</span>
            <h2>Sell Land</h2>
            <input
              type="text"
              placeholder="County"
              id="sellCounty"
              style="width: 100%; padding: 8px; margin-bottom: 10px"
            />
            <input
              type="text"
              placeholder="Constituency"
              id="sellConstituency"
              style="width: 100%; padding: 8px; margin-bottom: 10px"
            />
            <input
              type="number"
              placeholder="Price in KES"
              id="sellPrice"
              style="width: 100%; padding: 8px; margin-bottom: 10px"
            />
            <input
              type="text"
              placeholder="Size (e.g. 1/8 acre)"
              id="sellSize"
              style="width: 100%; padding: 8px; margin-bottom: 10px"
            />

            <button onclick="submitSell()">Submit</button>
            <button onclick="closeSellModal()">Cancel</button>
          </div>
        </div>
        <div class="sidebar-row">
          <button onclick="zoomIn()" class="half-button">Zoom In</button>
          <button onclick="zoomOut()" class="half-button">Zoom Out</button>
        </div>
        <div
          style="
            position: absolute;
            bottom: 20px;
            width: 230px;
            text-align: center;
            left: 10px;
          "
        >
          <button
            id="goToAdminButton"
            style="
              margin-bottom: 10px;
              padding: 8px 20px;
              background-color: #0d3867;
              color: white;
              border: none;
              border-radius: 5px;
            "
          >
            Login Admin
          </button>
          <br />
          <button
            onclick="openSupportModal()"
            style="
              padding: 8px 20px;
              background-color: #064f17;
              color: white;
              border: none;
              border-radius: 5px;
            "
          >
            Support
          </button>
        </div>
      </div>
      <div id="map"></div>
    </div>

    <script>
      window.addEventListener("load", () => {
        const loader = document.getElementById("loader");
        setTimeout(() => {
          loader.classList.add("hidden");
        }, 2500); // Adjust duration (2.5 seconds)
      });
    </script>

    <script>
      let map;

      // Function to search for a parcel by ID
      async function searchParcel() {
        const parcelId = document.getElementById("parcelInput").value;

        console.log("📦 Parcel ID entered:", parcelId); // Log 1

        if (!parcelId) {
          alert("Please enter a Parcel ID.");
          return;
        }

        if (!map) {
          console.error("❌ Map object is undefined."); // Log 2
          alert("Map is not ready yet. Please wait.");
          return;
        } else {
          console.log("🗺️ Map object exists:", map); // Log 3
        }

        fetch(`/api/parcels/${parcelId}`)
          .then((response) => {
            console.log("🌐 API Response Status:", response.status); // Log 4

            if (!response.ok) {
              throw new Error("Parcel not found");
            }
            return response.json();
          })
          .then((parcel) => {
            console.log("📦 Parcel Fetched:", parcel); // Log 5

            const lat = parcel.latitude;
            const lng = parcel.longitude;

            if (lat == null || lng == null) {
              alert("Parcel does not have valid location data.");
              return;
            }

            const center = { lat, lng };
            console.log("📍 Center to zoom to:", center); // Log 6

            map.setCenter(center);
            map.setZoom(16);

            const marker = new google.maps.Marker({
              position: center,
              map: map,
              title: parcel.parcelId,
            });

            const infoWindow = new google.maps.InfoWindow({
              content: `
          <div>
            <strong>Parcel ID:</strong> ${parcel.parcelId}<br>
            <strong>County:</strong> ${parcel.county || "N/A"}<br>
            <strong>Owner:</strong> ${parcel.ownerName || "N/A"}
          </div>
        `,
            });

            marker.addListener("mouseover", () => infoWindow.open(map, marker));
            marker.addListener("mouseout", () => infoWindow.close());
          })
          .catch((error) => {
            console.error("❌ Error fetching parcel:", error); // Log 7
            alert("Failed to find parcel. Please try again.");
          });
      }

      const counties = {
        baringo: { lat: 0.4646, lng: 35.7436 },
        bomet: { lat: -0.7821, lng: 35.3398 },
        bungoma: { lat: 0.5689, lng: 34.5584 },
        busia: { lat: 0.4347, lng: 34.2422 },
        "elgeyo marakwet": { lat: 1.0497, lng: 35.478 },
        embu: { lat: -0.656, lng: 37.7238 },
        garissa: { lat: -0.4532, lng: 39.646 },
        "homa bay": { lat: -0.5273, lng: 34.457 },
        isiolo: { lat: 0.3557, lng: 37.5822 },
        kajiado: { lat: -1.8536, lng: 36.7763 },
        kakamega: { lat: 0.2827, lng: 34.7519 },
        kericho: { lat: -0.3671, lng: 35.2836 },
        kiambu: { lat: -1.041, lng: 36.8681 },
        kilifi: { lat: -3.5105, lng: 39.9093 },
        kirinyaga: { lat: -0.6591, lng: 37.3827 },
        kisii: { lat: -0.6773, lng: 34.7795 },
        kisumu: { lat: -0.0917, lng: 34.7679 },
        kitui: { lat: -1.367, lng: 38.0106 },
        kwale: { lat: -4.1833, lng: 39.45 },
        laikipia: { lat: 0.3606, lng: 36.6984 },
        lamu: { lat: -2.228, lng: 40.9006 },
        machakos: { lat: -1.5177, lng: 37.2634 },
        makueni: { lat: -1.8041, lng: 37.6282 },
        mandera: { lat: 3.9373, lng: 41.8569 },
        meru: { lat: 0.3557, lng: 37.717 },
        migori: { lat: -1.0634, lng: 34.4731 },
        marsabit: { lat: 2.3399, lng: 37.9994 },
        mombasa: { lat: -4.0435, lng: 39.6682 },
        "murang'a": { lat: -0.7184, lng: 37.1406 },
        nairobi: { lat: -1.286389, lng: 36.817223 },
        nakuru: { lat: -0.3031, lng: 36.08 },
        nandi: { lat: 0.1145, lng: 35.3582 },
        narok: { lat: -1.1041, lng: 35.871 },
        nyamira: { lat: -0.5742, lng: 34.936 },
        nyandarua: { lat: -0.1806, lng: 36.5566 },
        nyeri: { lat: -0.4197, lng: 36.9476 },
        samburu: { lat: 1.2598, lng: 36.742 },
        siaya: { lat: 0.0612, lng: 34.2422 },
        "taita taveta": { lat: -3.3161, lng: 38.485 },
        "tana river": { lat: -1.2886, lng: 40.1169 },
        "tharaka nithi": { lat: -0.1841, lng: 37.9445 },
        "trans nzoia": { lat: 1.0556, lng: 34.95 },
        turkana: { lat: 3.3124, lng: 35.5658 },
        "uasin gishu": { lat: 0.3347, lng: 35.5372 },
        vihiga: { lat: 0.0741, lng: 34.7192 },
        wajir: { lat: 1.7504, lng: 40.0509 },
        "west pokot": { lat: 1.2891, lng: 35.1436 },
      };

      const greenIcon = {
        url: "http://maps.google.com/mapfiles/ms/icons/green-dot.png",
      };

      const landsForSale = [
        { id: 1, location: "Kajiado", size: "1 Acre", price: "Ksh 850,000" },
        {
          id: 2,
          location: "Kitengela",
          size: "1/2 Acre",
          price: "Ksh 450,000",
        },
        { id: 3, location: "Nakuru", size: "1/4 Acre", price: "Ksh 320,000" },
      ];

      function initMap() {
        // Initialize map with default center and map type
        map = new google.maps.Map(document.getElementById("map"), {
          center: { lat: 0, lng: 0 },
          zoom: 2,
          mapTypeId: "hybrid",
        });

        // Try to get user location
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              const userLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
              };

              // Center map on user's location
              map.setCenter(userLocation);
              map.setZoom(15);

              // Add "You are here" marker
              new google.maps.Marker({
                position: userLocation,
                map: map,
                title: "You are here",
              });
            },
            () => {
              alert("Location access denied or unavailable.");
            }
          );
        } else {
          alert("Geolocation is not supported by this browser.");
        }
      }
      // Try to get user's location
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            const userLocation = {
              lat: position.coords.latitude,
              lng: position.coords.longitude,
            };

            // Center map on user location
            map.setCenter(userLocation);

            // Optional: Add a marker at user location
            new google.maps.Marker({
              position: userLocation,
              map: map,
              title: "You are here!",
              icon: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png",
            });
          },
          () => {
            console.warn("Geolocation permission denied or unavailable.");
          }
        );
      } else {
        console.warn("Geolocation is not supported by this browser.");
      }

      // Red center markers
      for (const county in counties) {
        new google.maps.Marker({
          position: counties[county],
          map,
          title: county.charAt(0).toUpperCase() + county.slice(1),
          icon: {
            url: "http://maps.google.com/mapfiles/ms/icons/red-dot.png",
            scaledSize: new google.maps.Size(50, 50),
          },
        });
      }

      // County dropdown
      const dropdown = document.getElementById("countyDropdown");
      for (const county in counties) {
        const option = document.createElement("option");
        option.value = county;
        option.textContent = county.charAt(0).toUpperCase() + county.slice(1);
        dropdown.appendChild(option);
      }

      // Add dummy plot markers
      for (const county in counties) {
        const center = counties[county];
        for (let i = 0; i < 5; i++) {
          const latOffset = (Math.random() - 0.5) * 0.1;
          const lngOffset = (Math.random() - 0.5) * 0.1;
          const size = `${Math.floor(Math.random() * 3 + 1)} Acre(s)`;
          const price = `Ksh ${Math.floor(Math.random() * 1000000 + 300000)}`;
          const phone = `07${Math.floor(10000000 + Math.random() * 89999999)}`;
          const ref = `TLD-${Math.floor(1000 + Math.random() * 9000)}`;

          const marker = new google.maps.Marker({
            position: {
              lat: center.lat + latOffset,
              lng: center.lng + lngOffset,
            },
            map,
            icon: greenIcon,
            title: `${size}, ${price}`,
          });

          const info = new google.maps.InfoWindow({
            content: `
                <div>
                  <strong>Size:</strong> ${size}<br>
                  <strong>Price:</strong> ${price}<br>
                  <strong>Seller:</strong> ${phone}<br>
                  <strong>Ref:</strong> ${ref}
                </div>
              `,
          });

          marker.addListener("mouseover", () => info.open(map, marker));
          marker.addListener("mouseout", () => info.close());
        }
      }

      function goToCounty() {
        const selected = document.getElementById("countyDropdown").value;
        if (counties[selected]) {
          map.setCenter(counties[selected]);
          map.setZoom(10);
        }
      }

      function zoomIn() {
        map.setZoom(map.getZoom() + 1);
      }

      function zoomOut() {
        map.setZoom(map.getZoom() - 1);
      }

      function openBuyModal() {
        const list = document.getElementById("landList");
        list.innerHTML = "";

        landsForSale.forEach((land) => {
          const div = document.createElement("div");
          div.className = "land-item";
          div.textContent = "${land.location} – ${land.size} – ${land.price}";
          div.onclick = () => {
            document
              .querySelectorAll(".land-item")
              .forEach((item) => item.classList.remove("selected"));
            div.classList.add("selected");
            div.setAttribute("data-id", land.id);
          };
          list.appendChild(div);
        });

        document.getElementById("buyModal").style.display = "block";
      }

      function closeBuyModal() {
        document.getElementById("buyModal").style.display = "none";
      }

      function sendRequest() {
        const selected = document.querySelector(".land-item.selected");
        const phone = document.getElementById("buyerPhone").value.trim();

        if (!selected) {
          alert("Please select a land option.");
          return;
        }

        if (!phone || phone.length < 9) {
          alert("Enter a valid phone number.");
          return;
        }

        const landId = selected.getAttribute("data-id");
        const land = landsForSale.find((l) => l.id == landId);

        alert(
          "Your request to buy ${land.size} in ${land.location} at ${land.price} has been sent! We’ll contact you on ${phone}."
        );

        closeBuyModal();
      }
      function openSellModal() {
        document.getElementById("sellModal").style.display = "block";
      }

      function closeSellModal() {
        document.getElementById("sellModal").style.display = "none";
      }

      function submitSell() {
        const county = document.getElementById("sellCounty").value;
        const constituency = document.getElementById("sellConstituency").value;
        const price = document.getElementById("sellPrice").value;
        const size = document.getElementById("sellSize").value;

        if (county && constituency && price && size) {
          alert(
            "Land listed successfully!\nCounty: ${county}\nConstituency: ${constituency}\nPrice: ${price}\nSize: ${size}"
          );
          closeSellModal();
        } else {
          alert("Please fill in all fields.");
        }
      }
    </script>

    <script
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBK1h-QvnaLDOvRqz9cRDrCShpDAMzae-U&callback=initMap"
      async
      defer
    >
        async
        defer
      >
    </script>

    <div
      id="supportModal"
      style="
        display: none;
        position: fixed;
        z-index: 9999;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.6);
      "
    >
      <div
        style="
          background-color: rgb(240, 244, 241);
          margin: 15% auto;
          padding: 20px;
          border-radius: 8px;
          width: 300px;
          text-align: center;
        "
      >
        <h3>Support</h3>
        <p><strong>Phone:</strong> +254 712 345678</p>
        <p>
          <strong>Email:</strong>
          <a href="mailto:digitallandownership@gmail.com"
            >digitallandownership@gmail.com</a
          >
        </p>
        <button
          onclick="closeSupportModal()"
          style="margin-top: 10px; padding: 5px 15px"
        >
          Close
        </button>
      </div>
    </div>
    <script>
      function openSupportModal() {
        document.getElementById("supportModal").style.display = "block";
      }

      function closeSupportModal() {
        document.getElementById("supportModal").style.display = "none";
      }

      window.onclick = function (event) {
        const modal = document.getElementById("supportModal");
        if (event.target === modal) {
          closeSupportModal();
        }
      };
      // Moved this script block to ensure the button exists when the script runs
      const goToAdminButton = document.getElementById('goToAdminButton');

      if (goToAdminButton) { // Check if the button exists
          goToAdminButton.addEventListener('click', () => {
              window.location.href = 'loginAdmin.html';
          });
      } else {
          console.error("Button with ID 'goToAdminButton' not found!");
      }
    </script>
  </body>
</html>